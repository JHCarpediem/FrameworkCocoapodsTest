#include "Demo.h"
#include "Binary.h"
#include "DataFile.h"
#include "ArtiMsgBox.h"
#include "DemoAppLayer.h"
#include "ProFile.h"
#include "ArtiInput.h"
#include "PublicInterface.h"
#include "ArtiGlobal.h"
#include "Mathematics.h"
#include "ArtiMenu.h"
#include "DemoEnterSys.h"
#include "DemoAPITest.h"
#include "DemoHotFunction.h"
#include "DemoPublicAPI.h"
#include "DemoEcuTest.h"
#include "DemoUnlockGW.h"

namespace Topdon_AD900_Demo {

	Topdon_AD900_Demo::CModelInfo CDemo::m_ModelInfo;

	CDemo::CDemo()
	{
		CDataFile::SetVehPath(CArtiGlobal::GetVehPath());
		CDataFile::SetLanguage(CArtiGlobal::GetLanguage());
		//CDataFile::SetLanguage("en");


		// 		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_NORMAL_NONE, "DET_NORMAL_NONE");
		// 		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_BASE_VER, "DET_BASE_VER");
		// 		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_BASE_RDTC, "DET_BASE_RDTC");
		// 		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_BASE_CDTC, "DET_BASE_CDTC");
		// 		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_BASE_RDS, "DET_BASE_RDS");
		// 		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_BASE_ACT, "DET_BASE_ACT");
		// 		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_BASE_FFRAME, "DET_BASE_FFRAME");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_MT_OIL_RESET, artiGetText("500000060101"));///* Oil Reset */
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_MT_THROTTLE_ADAPTATION, artiGetText("500000060102"));//"Throttle Adaptation");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_MT_EPB_RESET, artiGetText("500000060103"));//"EPB Reset");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_ABS_BLEEDING, artiGetText("500000060104"));//"ABS Bleeding");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_STEERING_ANGLE_RESET, artiGetText("500000060105"));//"Steering Angle Reset");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_DPF_REGENERATION, artiGetText("500000060106"));//"DPF Regeneration");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_AIRBAG_RESET, artiGetText("500000060107"));//"Airbag Reset");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_BMS_RESET, artiGetText("500000060108"));//"BMS Reset");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_ADAS, artiGetText("500000060109"));//"ADAS");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_IMMO, artiGetText("50000006010A"));//"IMMO");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_SMART_KEY, artiGetText("50000006010B"));//"SmartKey");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_PASSWORD_READING, artiGetText("50000006010C"));//"PasswordReading");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_MT_EPB_RESET, artiGetText("50000006010D"));//"BrakeReplace");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_INJECTOR_CODE, artiGetText("50000006010E"));//"InjectorCode");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_SUSPENSION, artiGetText("50000006010F"));// "Suspension");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_TIRE_PRESSURE, artiGetText("500000060110"));//"TirePressure");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_TRANSMISSION, artiGetText("500000060111"));//"Transmission");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_GEARBOX_LEARNING, artiGetText("500000060112"));//"GearboxLearning");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_TRANSPORT_MODE, artiGetText("500000060113"));// "TransportMode");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_HEAD_LIGHT, artiGetText("500000060114"));//"Headlight");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_SUNROOF_INIT, artiGetText("500000060115"));// "SunroofInit");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_SEAT_CALI, artiGetText("500000060116"));//"SeatCali");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_WINDOW_CALI, artiGetText("500000060117"));// "WindowCali");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_START_STOP, artiGetText("500000060118"));// "StartStop");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_EGR, artiGetText("500000060119"));// "EGR");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_ODOMETER, artiGetText("50000006011A"));//"Odometer");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_LANGUAGE, artiGetText("50000006011B"));//"Language");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_TIRE_MODIFIED, artiGetText("50000006011C"));//"Tire");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_A_F_ADJ, artiGetText("50000006011D"));//"A_F_Adj");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_ELECTRONIC_PUMP, artiGetText("50000006011E"));//"ElectronicPump");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_NOx_RESET, artiGetText("50000006011F"));//"NoxReset");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_UREA_RESET, artiGetText("500000060120"));// "UreaReset");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_TURBINE_LEARNING, artiGetText("500000060121"));//"TurbineLearning");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_CYLINDER, artiGetText("500000060122"));//"Cylinder");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_EEPROM, artiGetText("500000060123"));//"EEPROM");
		mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DEF_MT_EXHAUST_PROCESSING, artiGetText("500000060124"));//"ExhaustProcessing");
		//mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_ALLFUN, "DET_ALLFUN");
		//mapeDiagEntryType.emplace(CArtiGlobal::eDiagEntryType::DET_INVALID, "DET_INVALID");
	}

	CDemo::~CDemo()
	{
		CDataFile::Destroy();
	}

	int32_t CDemo::MainEntry()
	{
		CArtiMenu	uiMenu;
		uint32_t	uRet;
		string		strPath;
		string		strVIN;
		string		strHistoryRecord;

		// 	strPath = CArtiGlobal::GetVehPath();
		// 	strPath += "\\";
		// 	setLanguage(CArtiGlobal::GetLanguage());
		// 	setPath(strPath);

// 		strHistoryRecord += artiGetText("500000000002");//自动？手动？
// 		strHistoryRecord += "@JN111111111111111";
// 		strHistoryRecord += "@";
// 		strHistoryRecord += "350Z";//车型
// 		strHistoryRecord += "@";
// 		strHistoryRecord += "2020";//年份

#ifndef WIN32

		if (CArtiGlobal::IsEntryFromHistory())
		{
			strHistoryRecord = CArtiGlobal::GetHistoryRecord();
		}
#endif // DEBUG
		//strHistoryRecord.clear();
		if (strHistoryRecord.size()>0)
		{
			vector<string>	vecstrHistory;

			vecstrHistory = SeparateString(strHistoryRecord, "@");
			if (vecstrHistory.size()>5)
			{
				m_ModelInfo.Clear();
				m_ModelInfo.SetDiagnosisType(vecstrHistory[0]);
				m_ModelInfo.SetModel(vecstrHistory[2]);
				m_ModelInfo.SetYear(vecstrHistory[3]);
				m_ModelInfo.SetEngineType(vecstrHistory[4]);
				m_ModelInfo.SetEngineSubType(vecstrHistory[5]);
				CArtiGlobal::SetVehInfo(m_ModelInfo.toString());
				CArtiGlobal::SetVIN(vecstrHistory[1]);
				SelectDiagType();
				return 0;
			}
		}

		strVIN = CArtiGlobal::GetVIN();
		if (strVIN.size() == 17)
		{
			CArtiGlobal::SetVIN(strVIN);
			CAppLayer	applayer;

			applayer.StartAppLayer();
		}
		uiMenu.InitTitle(artiGetText("FFFFFFFF0003"));
		uiMenu.AddItem(artiGetText("FFFFFFFF0004"));
		uiMenu.AddItem(artiGetText("FFFFFFFF0005"));

		string strLang = CArtiGlobal::GetLanguage();
		if (/*(String2Upper(strLang) == "CN") && */(CArtiGlobal::GetAppScenarios() == CArtiGlobal::eAppScenarios::AS_INTERNAL_USE))
		{
// 			uiMenu.AddItem(artiGetText("FF0000000020"));	// "接口测试";
// 			//uiMenu.AddItem(artiGetText("FF0F00000000"));	// "多系统诊断"
// 			uiMenu.AddItem(artiGetText("500000300000"));	// "Ecu测试";
// 			uiMenu.AddItem(artiGetText("500000400000"));	// 品牌切换		
			uiMenu.AddItem(artiGetText("500000400001"));	// 网关解锁		
		}
		
		while (1)
		{
			uRet = uiMenu.Show();
			if (uRet == DF_ID_BACK)
			{
				return 0;
			}
			uRet &= 0xff;

			// 添加车型路径 [11/28/2022 qunshang.li]
			m_ModelInfo.Clear();
			m_ModelInfo.SetDiagnosisType(uiMenu.GetItem(uRet));
			CArtiGlobal::SetVehInfo(m_ModelInfo.toString());
			// end [11/28/2022 qunshang.li]

			if (uRet == 0)
			{
				Automatic_Selection();
			}
			else if (uRet == 1)
			{
				Manual_Selection();
			}
// 			else if (uRet == 2)// 添加API测试程序 [2/14/2022 qunshang.li]
// 			{
// 				CAPITest apiTest;
// 
// 				if (0 == apiTest.ShowMenu())
// 				{
// 					return 0;
// 				}
// 				
// 			}
			else if (uRet == 2)
			{
				CUnlockGW unlockGw;

				unlockGw.ShowMenu();
				return 0;
			}
			else if (uRet == 3)// 添加ECU测试程序
			{
				CEcuTest EcuTest;
				EcuTest.TestEcu();
			}
			else if (uRet == 4)
			{
				ChangeVechile();
				return 0;
			}
			else if (uRet == 5)
			{
				CUnlockGW unlockGw;

				unlockGw.ShowMenu();
				return 0;
			}

			// 添加车型路径 [11/28/2022 qunshang.li]
			m_ModelInfo.SetDiagnosisType("");
			CArtiGlobal::SetVehInfo(m_ModelInfo.toString());
			// end [11/28/2022 qunshang.li]
		}
		return 0;
	}

	void CDemo::Automatic_Selection()
	{
		CArtiInput	uiInput;
		uint32_t	uRet;
		string		strVin;

		while (1)
		{
			uiInput.InitOneInputBox(artiGetText("FFFFFFFF006A"), artiGetText("FFFFFFFF000B"), "VVVVVVVVVVVVVVVVV", strVin);
			uiInput.AddButton(artiGetText("ReadVIN"));
			uRet = uiInput.Show();
			if (uRet == DF_ID_BACK)
			{
				return;
			}
			else if (uRet == DF_ID_FREEBTN_0)
			{
				// "正在读取VIN..."
				artiShowMsgBox(artiGetText("FFFFFFFF0010"), artiGetText("FFFFFFFF006D"), DF_MB_NOBUTTON);
				Delay(500);
				
				strVin = "JF14024F9L3067448";
				CArtiGlobal::SetVIN(strVin);
			}
			else
			{
				strVin = uiInput.GetOneInputBox();
				if (strVin.size() != 17)
				{
					artiShowMsgBox(artiGetText("FFFFFFFF000C"), artiGetText("FFFFFFFF000E"), DF_MB_OK);
					continue;
				}
				artiShowMsgBox(artiGetText("FFFFFFFF000C"), artiGetText("FFFFFFFF000D"), DF_MB_NOBUTTON);
				CArtiGlobal::SetVIN(strVin);

				CArtiList		uiVehicle;
				vector<int32_t> vctColWidth;
				bool			bClipEsc = false;

				uiVehicle.InitTitle(artiGetText("FFFFFFFF0080"));
				vctColWidth.push_back(30);
				vctColWidth.push_back(70);
				uiVehicle.SetColWidth(vctColWidth);
				uiVehicle.AddItem("VIN");
				uiVehicle.AddItem(artiGetText("500000020000"));

				uiVehicle.AddItem(artiGetText("500000030000"));
				uiVehicle.AddItem(artiGetText("5100000000E7"));//发动机
				uiVehicle.AddItem(artiGetText("5100000000E8"));//发动机子类型

				uiVehicle.AddButton(artiGetText("FFFFFFFF0015"));	//是
				uiVehicle.SetItem(0, 1, strVin);
				uiVehicle.SetItem(1, 1, "350Z");
				uiVehicle.SetItem(2, 1, "2020");
				uiVehicle.SetItem(3, 1, artiGetText("5100000000F6"));
				uiVehicle.SetItem(4, 1, artiGetText("5100000000F7"));

				while (1)
				{
					uint32_t uRet = uiVehicle.Show();
					if (DF_ID_FREEBTN_0 == uRet)
					{
						break;
					}
					else if (uRet == DF_ID_BACK)
					{
						bClipEsc = true;
						break;
					}
				}
				if (bClipEsc)
				{
					continue;
				}
				CDemo::m_ModelInfo.SetModel("350Z");
				CDemo::m_ModelInfo.SetYear("2020");
				CDemo::m_ModelInfo.SetEngineType(artiGetText("5100000000F6"));
				CDemo::m_ModelInfo.SetEngineSubType(artiGetText("5100000000F7"));
				//将历史记录设给APP
				SetMyHistory();
				SelectDiagType();
				break;
			}
		}
	}

	void CDemo::SelectDiagType()
	{
		CArtiGlobal::eDiagEntryType diagEntryType = CArtiGlobal::GetDiagEntryType();
		if (mapeDiagEntryType.find(diagEntryType) != mapeDiagEntryType.end())
		{
			ShowMainMenu();
#ifndef WIN32
			CArtiGlobal::SetHistoryMileage("20237", "20230");
			CArtiGlobal::SetHistoryMMY("DEMO", CDemo::m_ModelInfo.GetModel(), CDemo::m_ModelInfo.GetYear());
			CArtiGlobal::SetHistoryEngine(CDemo::m_ModelInfo.GetEngineType(), CDemo::m_ModelInfo.GetEngineSubType());
#endif
		}
		else
		{
			CArtiMenu		uiMenu;

			uiMenu.InitTitle(artiGetText("FFFFFFFF0016"));

			uiMenu.AddItem(artiGetText("FFFFFFFF0017"));
			uiMenu.AddItem(artiGetText("FFFFFFFF0019"));

			while (1)
			{
				uint32_t uMenu = uiMenu.Show();
				if (uMenu == DF_ID_BACK)
				{
					break;
				}
				if (uMenu == 1)
				{
					ShowMainMenu();
				}
				else
				{
					CAppLayer applay;
					applay.StartAppLayer();
				}
			}
		}
		return;
	}

	void CDemo::ShowMainMenu()
	{

		CHotFunction hotFunction;
		hotFunction.ShowMainMenu();
		//CArtiGlobal::SetVehInfo(m_ModelInfo.toString());

// 		uint32_t uRetMainMenu = DF_ID_NOKEY;
// 
// 		CArtiMenu uiMainMenu;
// 		uiMainMenu.InitTitle(artiGetText("Text_MainMenu"));
// 		uiMainMenu.AddItem(artiGetText("Text_Diagnostic"));
// 		uiMainMenu.AddItem(artiGetText("500000060100"));
// 
// 		while (1)
// 		{
// 			uRetMainMenu = uiMainMenu.Show();
// 			if (DF_ID_BACK == uRetMainMenu)
// 			{
// 				break;
// 			}
// 			else
// 			{
// 				uRetMainMenu = uRetMainMenu & 0xff;
// 
// 				// 添加车型路径 [11/28/2022 qunshang.li]
// 				m_ModelInfo.SetDiagnosisMenu(uiMainMenu.GetItem(uRetMainMenu));
// 				CArtiGlobal::SetVehInfo(m_ModelInfo.toString());
// 				// end [11/28/2022 qunshang.li]
// 
// 				if (0 == uRetMainMenu)
// 				{
// 					//开启应用层
// 					CAppLayer	appLayer;
// 					appLayer.StartAppLayer();
// 				}
// 				else
// 				{
// 					CHotFunction hotFunction;
// 					hotFunction.ShowMainMenu();
// 				}
// 
// 				// 添加车型路径 [11/28/2022 qunshang.li]
// 				m_ModelInfo.SetDiagnosisMenu("");
// 				CArtiGlobal::SetVehInfo(m_ModelInfo.toString());
// 				// end [11/28/2022 qunshang.li]
// 			}
// 		}

	}

	void CDemo::Manual_Selection()
	{
		CArtiMenu		uiMenu;

		uiMenu.InitTitle(artiGetText("500000020000"));
		uiMenu.AddItem("350Z");
		uiMenu.AddItem("370Z");
		while (1)
		{
			uint32_t iRet = uiMenu.Show();
			if (iRet == DF_ID_BACK)
			{

				break;
			}

			m_ModelInfo.SetModel(uiMenu.GetItem(iRet));
			CArtiGlobal::SetVehInfo(m_ModelInfo.toString());

			CArtiMenu uiMenuYear;

			uiMenuYear.InitTitle(artiGetText("500000030000"));
			uiMenuYear.AddItem("2021");
			uiMenuYear.AddItem("2020");

			while (1)
			{
				uint32_t iRetYear = uiMenuYear.Show();
				if (iRetYear == DF_ID_BACK)
				{
					break;
				}
				CArtiList		uiVehicle;
				vector<int32_t> vctColWidth;
				string			strVIN;
				uint32_t		iSet = 0;

				uiVehicle.InitTitle(artiGetText("Confirm_vehicle_profile"));
				vctColWidth.push_back(30);
				vctColWidth.push_back(70);
				uiVehicle.SetColWidth(vctColWidth);
				strVIN = CArtiGlobal::GetVIN();
				if (strVIN.size())
				{
					uiVehicle.AddItem("VIN");
					iSet = 1;
				}
				uiVehicle.AddItem(artiGetText("500000020000"));
				uiVehicle.AddItem(artiGetText("500000030000"));
				uiVehicle.AddItem(artiGetText("5100000000E7"));
				uiVehicle.AddItem(artiGetText("5100000000E8"));

				uiVehicle.AddButton(artiGetText("FFFFFFFF0015"));	//确定
				if (strVIN.size())
				{
					uiVehicle.SetItem(0, 1, strVIN);
				}
				uiVehicle.SetItem(0 + iSet, 1, uiMenu.GetItem(iRet));
				uiVehicle.SetItem(1 + iSet, 1, uiMenuYear.GetItem(iRetYear & 0xff));
				uiVehicle.SetItem(2 + iSet, 1, artiGetText("5100000000F6"));
				uiVehicle.SetItem(3 + iSet, 1, artiGetText("5100000000F7"));

				while (1)
				{
					uint32_t uRet = uiVehicle.Show();
					if (DF_ID_FREEBTN_0 == uRet)
					{
						break;
					}
				}
				m_ModelInfo.SetEngineType(artiGetText("5100000000F6"));
				m_ModelInfo.SetEngineSubType(artiGetText("5100000000F7"));
				m_ModelInfo.SetYear(uiMenuYear.GetItem(iRetYear &0xff));
				CArtiGlobal::SetVehInfo(m_ModelInfo.toString());
				//将历史记录设给APP
				SetMyHistory();
				SelectDiagType();
				m_ModelInfo.SetYear("");
				CArtiGlobal::SetVehInfo(m_ModelInfo.toString());
			}
			m_ModelInfo.SetModel("");
			CArtiGlobal::SetVehInfo(m_ModelInfo.toString());
		}
	}

	void CDemo::SetMyHistory()
	{
		string	strHistoryRecord;

		strHistoryRecord = m_ModelInfo.GetDiagType();
		strHistoryRecord += "@";
		strHistoryRecord += CArtiGlobal::GetVIN();//VIN
		strHistoryRecord += "@";
		strHistoryRecord += m_ModelInfo.GetModel();
		strHistoryRecord += "@";
		strHistoryRecord += m_ModelInfo.GetYear();
		strHistoryRecord += "@";
		strHistoryRecord += m_ModelInfo.GetEngineType();
		strHistoryRecord += "@";
		strHistoryRecord += m_ModelInfo.GetEngineSubType();
		CArtiGlobal::SetHistoryRecord(strHistoryRecord);
	}

	void CDemo::ChangeVechile()
	{
		vector<string>	vctstrVehicle;
		CArtiInput		uiInput;
		vector<string>	vctstr5VINVeh{"VIN","Vehicle"};
		vector<string>	vctstrMask{ "VVVVVVVVVVVVVVVVV","*****************" };
		vector<string>	vctInputValue;
		uiInput.InitManyInputBox(artiGetText("500000400000"), vctstr5VINVeh, vctstrMask);

		while (1)
		{
			uint32_t uRet = uiInput.Show();
			if (uRet == DF_ID_BACK)
			{
				return;
			}
			vctInputValue = uiInput.GetManyInputBox();
			if ((vctInputValue.size()>1) && (vctInputValue[0].size()==17) && (vctInputValue[1].size()>1))
			{
				break;
			}
			else
			{
				artiShowMsgBox("error", "please input again");
			}
		}
		CArtiGlobal::SetCurVehNotSupport(VBST_VEH_NOT_SUPPORT);
		CArtiGlobal::SetVIN(vctInputValue[0]);
		vctstrVehicle.push_back(vctInputValue[1]);
		CArtiGlobal::SetVehicle(vctstrVehicle);

	}
}

